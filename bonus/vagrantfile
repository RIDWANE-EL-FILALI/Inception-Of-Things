Vagrant.configure("2") do |config|
  config.vm.box = "ubuntu/jammy64"

  config.vm.define "gitlab-vm" do |gitlab|
    gitlab.vm.hostname = "gitlab-vm"
    gitlab.vm.network "private_network", ip: "192.168.56.110"
    gitlab.vm.network "forwarded_port", guest: 80, host: 8090, host_ip: "0.0.0.0"

    gitlab.vm.provider "virtualbox" do |vb|
      vb.name = "gitlab-vm"
      vb.memory = "8192"
      vb.cpus = 4
    end

    gitlab.vm.provision "shell", inline: <<-SHELL
      set -euo pipefail
      export DEBIAN_FRONTEND=noninteractive

      apt-get update
      apt-get install -y curl ca-certificates openssh-server tzdata perl

      curl -sS https://packages.gitlab.com/install/repositories/gitlab/gitlab-ce/script.deb.sh | bash

      # Install GitLab with the specified external URL and root password
      EXTERNAL_URL="http://192.168.56.110" \
      GITLAB_ROOT_PASSWORD="password123" \
      apt-get install -y gitlab-ce

      # Fix half-configured package cases
      apt-get -y -f install || true
      dpkg --configure -a || true

      # Ensure runsvdir is active before reconfigure
      systemctl enable --now gitlab-runsvdir

      # Reconfigure GitLab
      gitlab-ctl reconfigure

      # Restart GitLab services
      gitlab-ctl restart

      # Wait until web is ready (max ~10 min)
      for i in $(seq 1 120); do
        if curl -sf http://localhost/-/readiness | grep -q '"status":"ok"'; then
          echo "GitLab is ready"
          break
        fi
        sleep 5
      done

      # Final check (fail fast if not ready)
      curl -sf http://localhost/-/readiness | grep -q '"status":"ok"'

      echo "GitLab ready at: http://localhost:8090 (host) / http://192.168.56.110 (VM)"
      echo "Login: root / password123"
    SHELL
  end
end