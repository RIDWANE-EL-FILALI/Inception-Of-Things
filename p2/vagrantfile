Vagrant.configure("2") do |config|
  # first machine is a server machine
  config.vm.boot_timeout = 600
  config.vm.define "rel-filaS" do |server|
    server.vm.box = "bento/ubuntu-20.04"
    server.vm.hostname = "rel-filaS"
    server.vm.network "private_network", ip: "192.168.56.110"
    server.vm.provider "virtualbox" do |vb|
      vb.name = "rel-filaS"
      vb.memory = 2048
      vb.cpus = 2
    end
    server.vm.provision "shell", inline: <<-SHELL
      sudo apt-get update -y
      curl -sfL https://get.k3s.io | sh -
      sudo apt-get install -y python3 python3-pip
      pip3 install flask

      mkdir -p /home/vagrant/app
      echo 'from flask import Flask' > /home/vagrant/app/app.py
      echo 'import sys' >> /home/vagrant/app/app.py
      echo '' >> /home/vagrant/app/app.py
      echo 'app = Flask(__name__)' >> /home/vagrant/app/app.py
      echo '' >> /home/vagrant/app/app.py
      echo '@app.route("/")' >> /home/vagrant/app/app.py
      echo 'def home():' >> /home/vagrant/app/app.py
      echo '    return f"<pre>Hello from Flask app on port {sys.argv[1]}</pre>"' >> /home/vagrant/app/app.py
      echo '' >> /home/vagrant/app/app.py
      echo 'if __name__ == "__main__":' >> /home/vagrant/app/app.py
      echo '    port = int(sys.argv[1]) if len(sys.argv) > 1 else 5000' >> /home/vagrant/app/app.py
      echo '    app.run(host="0.0.0.0", port=port)' >> /home/vagrant/app/app.py

      for i in {1..3}; do
        nohup python3 /home/vagrant/app/app.py $((5000 + i)) > /dev/null 2>&1 &
      done
    SHELL
  end
end
